#!/usr/bin/env perl
# Author: Thomas Hackl, thackl@lim4.de

use warnings;
use strict;

if ( !@ARGV || $ARGV[0] =~ /-h/) {
    print "Compute mean and median coverage per sequence.\n";
    print "Requires bedtools and samtools.\n\n";
    print "Usage: bam-coverage <bam> > cov.tsv\n";
    exit;
}

# this fails to report 0 depth for ref seqs without any alignments
#open (BEDCOV, "bedtools genomecov -d -ibam $ARGV[0] |") or die $!; 
#open (CTGLEN, "samtools idxstats $ARGV[0] | cut -f2 |") or die $!;

open (SAMCOV, "samtools depth -aa $ARGV[0] |") or die $!;
my $cctg = undef;
my $tcov = 0;
my $tn = 0;
my ($ctg, $pos, $cov);
my %covs; # store for median comp.

while (<SAMCOV>) {
    chomp;
    ($ctg, $pos, $cov) = split("\t", $_);
    $cctg//= $ctg;
    $cctg ne $ctg && report_cov();
    $tcov+=$cov;
    $covs{$cov}++;
}
report_cov();


sub report_cov{
    my $mean = $tcov/$pos; # pos==length
    my $med = median_cov(\%covs,$pos);
    
    print sprintf("%s\t%d\t%0.2f\t%d\n", $cctg, $pos, $mean, $med);
    $cctg = $ctg;
    $tcov = 0;
    %covs = ();
}

sub median_cov{
    my ($c,$len) = @_;
    my $s = 0;
    my $l50 = $len/2;
    my $med;
    foreach (sort{$a<=>$b}keys %$c) {
        $s+=$c->{$_};
        if ($s > $l50){
            $med=$_;
            last;
        }
        
    }
    return $med // 0;
}
